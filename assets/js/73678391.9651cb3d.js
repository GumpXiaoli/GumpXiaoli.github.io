"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[9213],{7504:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>p,frontMatter:()=>r,metadata:()=>c,toc:()=>a});var l=s(4848),i=s(8453);const r={title:"gprof"},t="gprof",c={id:"dev-guide/gprof",title:"gprof",description:"Install",source:"@site/docs/dev-guide/97-gprof.md",sourceDirName:"dev-guide",slug:"/dev-guide/gprof",permalink:"/docs/dev-guide/gprof",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:97,frontMatter:{title:"gprof"},sidebar:"tutorialSidebar",previous:{title:"Fundamentals of Non-uniform grids in LBM",permalink:"/docs/dev-guide/lbm/fundamentals-nonuniform-grids"},next:{title:"Algorithm Library Design",permalink:"/docs/dev-guide/algorithm-libary-design"}},o={},a=[{value:"Install",id:"install",level:2},{value:"Usage Example",id:"usage-example",level:2},{value:"Reference",id:"reference",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.h1,{id:"gprof",children:"gprof"}),"\n",(0,l.jsx)(n.h2,{id:"install",children:"Install"}),"\n",(0,l.jsx)(n.p,{children:"Install from Source:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# If we have gperf 2.10.0\ncd gperf-2.10.0\nmkdir build\ncmake -DCMAKE_INSTALL_PREFIX=/opt/gperf ..\nmake -j8\nmake install\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Additionally, one important tool ",(0,l.jsx)(n.code,{children:"pprof"})," is in the ",(0,l.jsx)(n.code,{children:"src"})," directory."]}),"\n",(0,l.jsx)(n.h2,{id:"usage-example",children:"Usage Example"}),"\n",(0,l.jsx)(n.p,{children:"Codes:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-c++",children:'#include <algorithm>\n#include <random>\n#include <string>\n#include <vector>\n\nint main()\n{\n  std::vector<std::string> vec;\n  std::mt19937_64 gen(43);\n\n  for (int count = 0; count < 3; ++count)\n  {\n    for (int i = 0; i < 10 * 1000 * 1000; ++i)\n    {\n      char buf[64];\n      snprintf(buf, sizeof buf, "%016lx", gen());\n      vec.push_back(buf);\n    }\n    std::sort(vec.begin(), vec.end());  // \u5982\u679c\u7528 tcmalloc 2.5\uff0c\u8fd9\u884c\u6ce8\u91ca\u6389\u53cd\u800c\u4f1a\u53d8\u6162\uff01\n    vec.clear();\n  }\n}\n'})}),"\n",(0,l.jsxs)(n.p,{children:["Tests (",(0,l.jsx)(n.code,{children:"Ubuntu"})," 20.04 / Kernel 5.15.0/ g++ 9.4.0):"]}),"\n",(0,l.jsxs)(n.p,{children:["First the default ",(0,l.jsx)(n.code,{children:"malloc"})," in ",(0,l.jsx)(n.code,{children:"glibc"})," is used."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ g++ -O2 -Wall -g sort_string.cc\n$ time ./a.out\nreal\t0m19.303s\nuser\t0m19.042s\nsys\t0m0.256s\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Then ",(0,l.jsx)(n.code,{children:"tcmalloc"})," is used:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"# \u4ee3\u7801\u6709\u6bd4\u8f83\u591a\u7684\u5c0f\u5757\u5185\u5b58\u5206\u914d\u4e0e\u91ca\u653e\uff0c\u6362\u6210 tcmalloc \u540e\u6027\u80fd\u7565\u6709\u63d0\u5347\n$ g++ -O2 -Wall -g sort_string.cc -ltcmalloc_and_profiler\n$ time ./a.out\nreal\t0m18.750s\nuser\t0m18.525s\nsys\t0m0.220s\n"})}),"\n",(0,l.jsx)(n.p,{children:"Using profiler to generate profile data:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ CPUPROFILE=prof.out ./a.out\nPROFILE: interrupts/evictions/bytes = 1880/418/56984\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Using ",(0,l.jsx)(n.code,{children:"pprof"})," to analyze:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ pprof --text ./a.out ./prof.out\nTotal: 1880 samples\n     946  50.3%  50.3%      946  50.3% __nss_database_lookup\n     242  12.9%  63.2%      242  12.9% _init@50000\n      60   3.2%  66.4%      109   5.8% psiginfo\n      56   3.0%  69.4%       56   3.0% __gnu_cxx::__normal_iterator::operator-- (inline)\n      49   2.6%  72.0%      294  15.6% PackedCache::TryGet\n      ...\n"})}),"\n",(0,l.jsx)(n.p,{children:"The meaning of each column:"}),"\n",(0,l.jsx)(n.admonition,{type:"info",children:(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"Sample number (excluding other functions)."}),"\n",(0,l.jsx)(n.li,{children:"Sample percentage (excluding other functions)."}),"\n",(0,l.jsx)(n.li,{children:"Till now, sample percentage (excluding other functions)."}),"\n",(0,l.jsx)(n.li,{children:"Sample number (including other functions)."}),"\n",(0,l.jsx)(n.li,{children:"Sample percentage (including other functions)"}),"\n",(0,l.jsx)(n.li,{children:"Function name."}),"\n"]})}),"\n",(0,l.jsx)(n.p,{children:"Or output pdf:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ pprof --pdf ./a.out ./prof.out > test.pdf\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{alt:"pdf",src:s(906).A+"",width:"1044",height:"964"})}),"\n",(0,l.jsxs)(n.p,{children:["Or output flame graph (",(0,l.jsx)(n.code,{children:"FlameGraph"})," tool is needed.)"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"$ pprof --collapsed ./a.out prof.out > test.cbt\n$ FlameGraph/flamegraph.pl test.cbt > test.svg\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.img,{alt:"flameGraph",src:s(1013).A+"",width:"1200",height:"534"})}),"\n",(0,l.jsx)(n.h2,{id:"reference",children:"Reference"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.a,{href:"https://zhuanlan.zhihu.com/p/558677729",children:"https://zhuanlan.zhihu.com/p/558677729"})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},1013:(e,n,s)=>{s.d(n,{A:()=>l});const l=s.p+"assets/images/flameGraph-ed82b045f245e93080d2fd2fad7996bb.svg"},906:(e,n,s)=>{s.d(n,{A:()=>l});const l=s.p+"assets/images/gprof-pdf-a4aa222b03876820df3316049bbc81c9.png"},8453:(e,n,s)=>{s.d(n,{R:()=>t,x:()=>c});var l=s(6540);const i={},r=l.createContext(i);function t(e){const n=l.useContext(r);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),l.createElement(r.Provider,{value:n},e.children)}}}]);